name: Coverage Report

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven
      - name: Run tests and generate JaCoCo report
        run: mvn -Djkube.skip=true test jacoco:report
      - name: Generate KDoc documentation
        run: mvn -Djkube.skip=true -DskipTests dokka:dokka
      - name: Collect KDoc output for Pages
        run: |
          mkdir -p target/site
          rm -rf target/site/dokka
          cp -R target/dokka target/site/dokka
      - name: Generate badge endpoint
        run: |
          python3 - <<'PY'
          import os
          import csv
          import json
          csv_path = "target/site/jacoco/jacoco.csv"
          with open(csv_path, newline="") as f:
              rows = list(csv.DictReader(f))
          missed = sum(int(r["INSTRUCTION_MISSED"]) for r in rows)
          covered = sum(int(r["INSTRUCTION_COVERED"]) for r in rows)
          total = missed + covered
          pct = 0 if total == 0 else round(100 * covered / total, 1)
          if pct < 60:
              color = "red"
          elif pct < 80:
              color = "yellow"
          else:
              color = "green"
          data = {"schemaVersion": 1, "label": "coverage", "message": f"{pct}%", "color": color}
          os.makedirs("target/site", exist_ok=True)
          with open("target/site/jacoco/jacoco.json", "w") as out:
              json.dump(data, out)
          with open("target/site/jacoco.json", "w") as out:
              json.dump(data, out)
          PY
      - uses: actions/upload-pages-artifact@v3
        with:
          path: target/site

  deploy-pages:
    needs: coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/deploy-pages@v4
